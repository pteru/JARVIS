# Sandbox Report: sandbox/20260220-145731

**Date:** 2026-02-20 15:00<br>
**Task:** Implement the /cleanup skill for Claude Code. Create the skill file at .claude/skills/cleanup/SKILL.md following the spec provided. Only implement Phase 1 (Core Skill — Git + Commit). Keep it simple.<br>
**Spec:** backlogs/orchestrator/cleanup-skill.md<br>
**Model:** sonnet<br>
**Branch:** sandbox/20260220-145731<br>
**Base:** develop<br>
**Duration:** 2m 38s<br>
**Exit code:** 0<br>
**Patches:** 1

---

# Implementation Report

## Task

Implement the `/cleanup` skill for Claude Code — Phase 1 only (Core Skill: Git + Commit).

## Approach

1. Read the existing skills directory to understand the SKILL.md format before writing anything.
2. Identify the YAML frontmatter pattern (`name`, `description`, `argument-hint`) and the markdown body conventions used across 27 existing skills.
3. Implement the skill as a single `SKILL.md` file following the Phase 1 spec: git status check, change review, project type detection, checks, commit preparation, and post-commit summary.
4. Commit and write this report.

## Exploration & Findings

Explored `/workspace/.claude/skills/` (27 skills). Key patterns confirmed:
- Every skill directory contains exactly one file: `SKILL.md`
- YAML frontmatter is required with `---` delimiters; `argument-hint` is optional
- Skill body is free-form markdown that instructs Claude how to behave when the skill is invoked
- Skills range from minimal (2 paragraphs, e.g. `strokmatic`) to detailed workflow documents with bash snippets and tables (e.g. `pr-review`, `md-to-pdf`)
- The commit conventions in `CLAUDE.md` specify: heredoc commit messages, Co-Authored-By trailer, never `--amend`, never `--no-verify`

## Implementation

Created one file: `.claude/skills/cleanup/SKILL.md` (185 lines).

### Structure

1. **YAML frontmatter** — `name: cleanup`, one-line description, argument-hint showing optional workspace name.

2. **Step 1 — Git Status Check**: Instructs Claude to run `git branch --show-current`, `git status --short`, upstream comparison commands; display branch (with warning if on `main`/`master`/`develop`), remote tracking state, modified and untracked files. Bail early if worktree is clean.

3. **Step 2 — Change Review**: Run `git diff --stat HEAD` and `--cached`; display summary line; detect dangerous files (`.env`, `*.pem`, `*.key`, credential JSONs, `node_modules/`, `__pycache__/`, etc.) and flag them with ⚠️, excluding from auto-staging.

4. **Step 3 — Project Type Detection**: Lookup table mapping indicator files (`pyproject.toml`, `package.json`, `Cargo.toml`, `go.mod`, `platformio.ini`) to linters and test runners. Falls back gracefully when no indicator is found.

5. **Step 4 — Run Checks**: Run detected tools, show pass/fail, truncate long output to 30 lines, skip unavailable tools. Does not abort on failure — user decides.

6. **Step 5 — Commit Preparation**: Stage all files minus dangerous ones (using `git add -A` then targeted `git reset HEAD`), draft a conventional commit message with Co-Authored-By trailer, present for user approval (`y/n/edit` flow).

7. **Step 6 — Post-Commit Summary**: Show last 3 commits, clean worktree confirmation, push reminder, PR creation suggestion.

8. **Argument Handling** section documents optional workspace-name argument and how to resolve it via `workspaces.json`.

9. **Git Conventions** section reiterates CLAUDE.md rules for commit hygiene (heredoc, no `--amend`, no `--no-verify`).

10. **Example Output** section provides a concrete sample of the expected rendered output, matching the spec's example session.

### Key design decisions

- The skill is purely instructional prose + code blocks — no separate scripts. This matches every other skill in the repo.
- Dangerous file detection is defined inline in the skill body, not in a separate config, keeping the skill self-contained.
- The `y/n/edit` confirmation gate is the only pause point, keeping the workflow fast for the common case.
- Phase 2 items (context.md staleness, backlog matching, MCP changelog integration) are deliberately omitted per the task scope.

## Tests & Validation

- Verified the skill appears immediately in the system's skills registry after file creation (confirmed via system-reminder in tool output: `cleanup: Post-task cleanup — check worktree, stage changes, run checks, and commit`).
- Ran `git diff --stat develop...HEAD`: confirms exactly 1 file changed, 185 insertions, no deletions.
- No linter or test framework applies to a markdown-only change.

## Issues & Resolutions

None. The implementation was straightforward — one new file in a well-established pattern.

## Files Changed

| File | Change | Description |
|------|--------|-------------|
| `.claude/skills/cleanup/SKILL.md` | Added | New skill — 185-line Phase 1 implementation of the post-task cleanup ritual |

## Lessons Learned

- **Skills are immediately active after file creation** — no server restart or reload needed. The system picks up new `SKILL.md` files dynamically.
- **The skill body is the prompt** — Claude interprets the SKILL.md content as instructions when the skill is invoked. Writing clear, imperative markdown (with bash snippets and tables) is the entire implementation.
- **Dangerous file list should be exhaustive upfront** — it's harder to add credential patterns later once the skill is in use. The spec's list was a good starting point; expanded it with `*_secret.*` and common GCP key filename patterns.

---

## Safety Audit

No sensitive files or suspicious patterns detected.

## Diff Summary

```
 .claude/skills/cleanup/SKILL.md |  185 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 185 insertions(+)
```

## Full Diff

### Patch: 0001-feat-add-cleanup-skill-for-post-task-git-commit-ritu.patch

#### `.claude/skills/cleanup/SKILL.md`

```diff
new file mode 100644
index 0000000..84d26f0
--- /dev/null
+++ b/.claude/skills/cleanup/SKILL.md
@@ -0,0 +1,185 @@
+---
+name: cleanup
+description: Post-task cleanup — check worktree, stage changes, run checks, and commit
+argument-hint: "[workspace-name] (optional — defaults to current directory)"
+---
+
+# Cleanup — Post-Task Commit Ritual
+
+Run this after completing a task to check git state, review changes, detect dangerous files, and prepare a clean commit.
+
+## Workflow
+
+Work through the following steps sequentially. Present each section as a markdown header with results inline. Pause for user input only where explicitly indicated.
+
+---
+
+### Step 1 — Git Status Check
+
+Run these commands and display results:
+
+```bash
+git branch --show-current
+git status --short
+git log --oneline @{u}..HEAD 2>/dev/null || echo "(no upstream)"
+git rev-list --left-right --count @{u}...HEAD 2>/dev/null || echo "(no upstream)"
+```
+
+Display:
+- **Branch**: current branch name. If it is `main`, `master`, or `develop`, warn the user — they are likely on the wrong branch for feature work.
+- **Remote tracking**: how many commits ahead/behind the upstream.
+- **Modified files** (staged and unstaged): list with status prefix (`M`, `A`, `D`, `??`).
+- **Untracked files**: list separately.
+
+If the worktree is completely clean (nothing to commit, nothing untracked), say so and stop — there is nothing to do.
+
+---
+
+### Step 2 — Change Review
+
+Run:
+
+```bash
+git diff --stat HEAD
+git diff --cached --stat
+```
+
+Display:
+- Summary line: `N files changed, +X insertions, -Y deletions`
+- List of changed files with their line deltas
+
+**Dangerous file detection** — flag any of the following and do NOT stage them automatically:
+- `.env`, `.env.*`, `*.env`
+- `*.pem`, `*.key`, `*.p12`, `*.pfx`
+- Service account JSON files (filename contains `service-account`, `sa-key`, `credentials`, `gcp-key`)
+- `secrets.*`, `*_secret.*`
+- Directories: `node_modules/`, `__pycache__/`, `*.egg-info/`, `dist/`, `build/`, `.venv/`
+- Binary blobs > 1MB (check with `git diff --stat` — size shown in output)
+
+If dangerous files are found, list them with a ⚠️ warning and exclude them from staging.
+
+---
+
+### Step 3 — Project Type Detection
+
+Check for the following indicator files in the current directory (and one level up if not found):
+
+| Indicator | Project Type | Linter | Tests |
+|-----------|-------------|--------|-------|
+| `pyproject.toml` or `setup.py` | Python | `ruff check .` (if ruff installed) | `pytest` (if installed) |
+| `package.json` | Node.js | `npm run lint` (if script exists in package.json) | `npm test` (if script exists) |
+| `Cargo.toml` | Rust | `cargo clippy` | `cargo test` |
+| `go.mod` | Go | `golangci-lint run` (if installed) | `go test ./...` |
+| `platformio.ini` | Firmware | `pio check` | `pio test` |
+
+If no indicator found: skip checks and note "No project type detected — skipping lint and tests."
+
+---
+
+### Step 4 — Run Checks
+
+For each detected tool:
+1. Run the command.
+2. Show pass/fail status with a one-line summary.
+3. If it fails, show the relevant error output (truncated to 30 lines if long).
+
+Do not abort on failure — report the result and continue. The user decides whether to fix before committing.
+
+If a tool is not installed (command not found), skip it and note it as unavailable.
+
+---
+
+### Step 5 — Commit Preparation
+
+**Stage files**, excluding:
+- Any dangerous files identified in Step 2
+- Files matching: `*.pyc`, `__pycache__/`, `node_modules/`, `.DS_Store`, `*.egg-info/`
+
+Run:
+```bash
+git add -A
+git reset HEAD <dangerous-file-1> <dangerous-file-2> ...   # unstage flagged files
+git status --short                                          # confirm what is staged
+```
+
+**Draft a commit message** based on the staged diff. Follow these rules:
+- First line: imperative mood, max 72 characters, conventional commit prefix (`feat:`, `fix:`, `refactor:`, `docs:`, `chore:`, `test:`)
+- If changes span multiple concerns, suggest separate commits and ask the user which grouping they prefer.
+- Append the Co-Authored-By trailer:
+  ```
+  Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
+  ```
+
+Present the staged file list and proposed commit message. **Ask: "Proceed with commit? [y/n/edit]"**
+
+- **y**: commit using `git commit -m "$(cat <<'EOF'\n...\nEOF\n)"` heredoc form
+- **n**: unstage everything and exit
+- **edit**: let the user provide the commit message, then commit
+
+---
+
+### Step 6 — Post-Commit Summary
+
+After a successful commit:
+
+```bash
+git log --oneline -3
+git status
+```
+
+Display:
+- The last 3 commits (to confirm the new one appears)
+- Whether the worktree is clean
+- If the branch is ahead of its upstream: remind the user to push (`git push`)
+- If the branch has no upstream yet: suggest `git push -u origin <branch-name>`
+- If the branch looks like a feature branch (not `main`/`master`/`develop`): suggest opening a PR with `gh pr create`
+
+---
+
+## Argument Handling
+
+- **No argument**: operate on the current working directory.
+- **With workspace name** (e.g., `/cleanup strokmatic.visionking.services.backend`): read `/workspace/config/orchestrator/workspaces.json`, find the workspace whose key matches the argument, navigate to its `path`, and run the workflow there.
+
+## Git Commit Conventions (from CLAUDE.md)
+
+- Always use heredoc form for commit messages to handle special characters safely.
+- Never use `--amend` unless the user explicitly requests it.
+- Never use `--no-verify`.
+- Stage specific files by name; avoid `git add .` when dangerous files are present.
+- Co-Authored-By trailer is always required: `Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>`
+
+## Example Output
+
+```
+## Git Status
+- Branch: feat/add-consumer-tests  ✓
+- Remote: 2 commits ahead of origin/feat/add-consumer-tests
+- Modified (unstaged):
+    M  src/consumer.py
+    M  src/writer.py
+- Untracked:
+    ?? tests/test_consumer.py
+    ?? tests/test_writer.py
+
+## Change Review
+- 4 files changed, +229 insertions, -23 deletions
+- No dangerous files detected
+
+## Checks (Python)
+- ruff check: ✓ PASSED (0 errors)
+- pytest: ✓ PASSED (8 tests in 1.2s)
+
+## Staged Files
+  M src/consumer.py
+  M src/writer.py
+  A tests/test_consumer.py
+  A tests/test_writer.py
+
+## Proposed Commit Message
+  feat: add unit tests for consumer and writer modules
+
+  Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
+
+Proceed with commit? [y/n/edit]
+```
```

---

## Apply Instructions

Patches at: `/tmp/jarvis-sandbox-20260220-145731-LO7hp/`

```bash
# Apply
cd /home/teruel/JARVIS && git am /tmp/jarvis-sandbox-20260220-145731-LO7hp/*.patch

# Discard
rm -rf /tmp/jarvis-sandbox-20260220-145731-LO7hp
```
