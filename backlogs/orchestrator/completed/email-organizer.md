# Email Organizer Tool + MCP Server

**Status:** Done
**Completed:** 2026-02-17

## Purpose

Integrate email ingestion from `workspaces/strokmatic/sdk/project-organizer` into JARVIS as a standalone tool. Strips Claude API dependency — uses rule-based classification and heuristic parsing for data plumbing, delegates intelligence to Claude Code via MCP tools.

## Components

### 1. `tools/email-organizer/main.py` — Python CLI tool

Standalone Python CLI with its own `.venv` and `python-dateutil` dependency.

**Subcommands:**

| Subcommand | Purpose |
|------------|---------|
| `fetch` | Connect to IMAP, download new emails from 5-digit labeled folders, auto-classify |
| `classify` | Route emails to correct PMO project folder using project-code map + heuristics |
| `parse` | Extract structured data (headers, body, attachments, heuristics) from raw .eml files |
| `ingest` | Full pipeline: fetch → classify → parse (convenience wrapper) |
| `list` | Show ingested emails per project with status |
| `reprocess` | Re-run parse on existing emails with `--force` (useful after map updates) |

**Key features ported from SDK project-organizer:**

- IMAP polling with 5-digit Gmail label detection
- `X-Email-KB-Project-Code` header injection for reliable project code tracking
- SHA-256 content-based deduplication
- RFC 2047 encoded header decoding
- Multipart email body extraction (text + HTML)
- Attachment saving with name-collision deduplication
- Text extraction from text-extractable attachments (`.txt`, `.md`, `.csv`, `.json`, `.xml`, `.html`, `.log`)
- Thread tracking via Message-ID / In-Reply-To / References headers
- Heuristic extraction: action items, date patterns, participant lists
- IMAP state persistence (`data/email-organizer/imap_state.json`)

### 2. `config/project-codes.json` — Classification map

```json
{
  "02008": {
    "name": "Nissan Smyrna Spot Fusion",
    "keywords": ["nissan", "smyrna", "spot fusion", "comau", "spotfusion"],
    "senders": ["joshua.young@nissan", "kirk.cumbo@comau"],
    "pmo_path": "workspaces/strokmatic/pmo/02008"
  }
}
```

Classification priority: subject keyword match (3 pts) → body keyword match (2 pts) → sender match (5 pts) → fallback to `unclassified/`.

### 3. `mcp-servers/email-analyzer/` — MCP server (Node.js)

Provides 6 tools for AI-powered email analysis, invoked by Claude Code during conversational analysis:

| Tool | Purpose |
|------|---------|
| `classify_email` | Classify an email into project + category (technical/administrative/discussion/status) |
| `extract_entities` | Write extracted entities (key_dates, action_items, decisions, technical_notes, references) to parsed JSON |
| `update_project_report` | Write/update `technical_report.md` with automatic history backup |
| `extract_timeline` | Write/merge timeline events to `timeline.json` with (date, description) deduplication |
| `get_project_emails` | Retrieve parsed emails for analysis (supports `include_body` and `unanalyzed_only` filters) |
| `get_project_context` | Get project stats, report preview, timeline summary, categorization counts |

### 4. Skills

| Skill | Purpose |
|-------|---------|
| `/email-organizer` | Documents CLI tool usage for email data plumbing operations |
| `/email-analyze` | Orchestrates AI analysis: classify → extract entities → generate report/timeline |

## Storage Layout

```
pmo/{code}/
  emails/
    raw/           ← .eml files (original)
    parsed/        ← .json per email (structured extraction + entities)
    index.json     ← master index: hash, date, from, to, subject, category, attachments
  attachments/     ← deduplicated, indexed by email hash prefix
  technical_report.md  ← generated by update_project_report MCP tool
  timeline.json        ← generated by extract_timeline MCP tool
  history/             ← timestamped report backups
```

## What Changed from Original SDK Project-Organizer

| Aspect | Original (SDK) | New (JARVIS) |
|--------|----------------|--------------|
| Classification | Claude API call per email | Rule-based: keyword + sender from project-codes.json |
| Entity extraction | Claude API extracts entities | Heuristic first, then Claude Code via MCP tool |
| Report generation | Claude API generates `technical_report.md` | Claude Code via `/email-analyze` skill + MCP tool |
| Email parsing | Claude API + local parsing | Local parsing only (stdlib `email` + `dateutil`) |
| Storage | Flat `02008-proj-organizer/` dir | Integrated into PMO folder structure |
| SMTP server | aiosmtpd for receiving forwarded emails | Removed — IMAP polling only |
| Watchdog | Filesystem watcher for new .eml files | Removed — CLI-driven, can be cron'd |
| Dependencies | `anthropic`, `watchdog`, `aiosmtpd`, `pypdf` | `python-dateutil` only |

## Environment Variables

| Variable | Required | Default | Purpose |
|----------|----------|---------|---------|
| `IMAP_USERNAME` | For fetch | — | Gmail username |
| `IMAP_PASSWORD` | For fetch | — | Gmail app password |
| `IMAP_HOST` | No | `imap.gmail.com` | IMAP server hostname |
| `JARVIS_HOME` | No | Auto-detected from script location | JARVIS root directory |

## Registration

MCP server registration:
```bash
claude mcp add email-analyzer node /home/teruel/JARVIS/mcp-servers/email-analyzer/index.js
```
